<!--*****************************************************************************************
 * File: SecurityHeaders.html
 * Version: 1.5.4
 * Last Updated: 2023-12-08
 *
 * Description:
 *   Provides security-related JavaScript functionality for the application.
 *   Implements MutationObserver patch and safe navigation handling.
 *
 * Changes in 1.5.4:
 *   - Removed meta CSP headers (now handled by HTTP headers)
 *   - Updated Permissions-Policy to use supported features only
 *   - Removed meta X-Frame-Options (now handled by HTTP headers)
 *   - Enhanced iframe sandbox security
 ******************************************************************************************-->

<!-- Base meta tags -->
<meta charset="UTF-8">
<meta name="referrer" content="strict-origin-when-cross-origin">
<meta http-equiv="X-Content-Type-Options" content="nosniff">

<!-- Updated Permissions-Policy with only supported features -->
<meta http-equiv="Permissions-Policy" content="camera=(), microphone=(), geolocation=(), display-capture=(), fullscreen=(), payment=()">

<?!= include('script'); ?>
<?!= include('style'); ?>

<script nonce="<?!= nonce ?>">
// Initialize MutationObserver safely
(function() {
  if (typeof MutationObserver !== 'undefined') {
    const observer = new MutationObserver(function(mutations) {
      mutations.forEach(function(mutation) {
        if (mutation.type === 'childList') {
          // Handle DOM changes here
          const elements = mutation.target.getElementsByTagName('iframe');
          for (let iframe of elements) {
            // Set secure sandbox attributes for iframes
            if (iframe.hasAttribute('sandbox')) {
              // Never allow both allow-scripts and allow-same-origin
              iframe.setAttribute('sandbox', 'allow-scripts allow-forms allow-popups');
            } else {
              // Add sandbox attribute if missing
              iframe.setAttribute('sandbox', 'allow-scripts allow-forms allow-popups');
            }
          }
        }
      });
    });

    // Start observing when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      const targetNode = document.body;
      if (targetNode) {
        observer.observe(targetNode, {
          childList: true,
          subtree: true
        });
      }
    });
  }
})();

// Safe navigation handling
function safeNavigate(url) {
  try {
    if (!url) return;
    
    // Validate URL
    const urlObj = new URL(url, window.location.origin);
    const allowedDomains = [
      'script.google.com',
      'google.com',
      window.location.hostname
    ];
    
    if (allowedDomains.some(domain => urlObj.hostname.endsWith(domain))) {
      window.location.href = urlObj.href;
    } else {
      console.error('Navigation blocked: Invalid domain');
    }
  } catch (error) {
    console.error('Navigation error:', error);
  }
}

// Handle form submissions
document.addEventListener('submit', function(e) {
  const form = e.target;
  if (!form.hasAttribute('data-safe-submit')) {
    e.preventDefault();
    console.warn('Form submission blocked: Missing data-safe-submit attribute');
  }
});
</script>